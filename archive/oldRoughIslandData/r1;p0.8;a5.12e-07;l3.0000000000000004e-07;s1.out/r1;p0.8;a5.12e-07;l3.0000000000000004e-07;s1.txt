
    randSeed(1)
    ThermSeed(1)


    resolution := 2e-09
    zResolution := 5e-09
    a := 5.12e-07

    gridSize := 512 //2*a/resolution
    gridDepth := 5 //25/zResolution

    SetCellsize(resolution,resolution,zResolution)
    SetGridsize(gridSize,gridSize,gridDepth)

    SetPBC(16, 16, 0)


    Msat = 700e3
    Aex = 13e-12
    alpha = 0.2
    Bmax := 0.1
    Bstep := Bmax / 500.0


    TableAdd(B_ext)
    TableAdd(m_full)


    islandWidth := 8e-08
    islandLength := 3.0000000000000004e-07
    ellipseConstant:=1.2000000000000002e-07


    hIsland := rect(islandLength-2*ellipseConstant, islandWidth)
    hIsland = hIsland.add(ellipse(ellipseConstant*2,islandWidth).transl(islandLength/2-ellipseConstant, 0, 0))
    hIsland = hIsland.add(ellipse(ellipseConstant*2,islandWidth).transl(-islandLength/2+ellipseConstant, 0, 0))
    
    hIsland = hIsland.add(rect(1.0307740770790707e-09,1.0307740770790707e-09).transl(-1.9039727145941242e-08,-4e-08,0))
hIsland = hIsland.add(rect(5.308641309440265e-09,5.308641309440265e-09).transl(4.208618402030537e-08,-3.979659973725745e-08,0))
hIsland = hIsland.add(rect(8.470382593883532e-09,8.470382593883532e-09).transl(6.896112837556421e-08,3.783301097616384e-08,0))
hIsland = hIsland.sub(rect(1.4160477748069522e-09,1.4160477748069522e-09).transl(-4.3916153485785816e-08,-3.97301182594096e-08,0))
hIsland = hIsland.add(rect(8.519893444611899e-09,8.519893444611899e-09).transl(1.1677839571903203e-07,2.7627502473745022e-08,0))
hIsland = hIsland.sub(rect(9.863503666461144e-09,9.863503666461144e-09).transl(1.4991578706808848e-07,1.4982957667100145e-09,0))
hIsland = hIsland.sub(rect(6.4899370824336355e-09,6.4899370824336355e-09).transl(6.0599030137874e-08,-3.8677727375815945e-08,0))
hIsland = hIsland.sub(rect(3.602832187231021e-09,3.602832187231021e-09).transl(-4.7923670077775545e-08,-3.955129166445776e-08,0))
hIsland = hIsland.sub(rect(3.6303079021366313e-09,3.6303079021366313e-09).transl(-4.530331281645371e-08,3.967340085251881e-08,0))
hIsland = hIsland.add(rect(2.360212989029027e-09,2.360212989029027e-09).transl(3.560972614616386e-08,3.995626911257001e-08,0))
hIsland = hIsland.add(rect(9.891377961378147e-09,9.891377961378147e-09).transl(-7.541197558108293e-08,-3.7025145320178665e-08,0))
hIsland = hIsland.sub(rect(5.265172076085205e-09,5.265172076085205e-09).transl(3.11909022413016e-08,3.9998030162401834e-08,0))
hIsland = hIsland.add(rect(1.154894246675945e-09,1.154894246675945e-09).transl(-1.0537152292275354e-07,3.1125433566466794e-08,0))
hIsland = hIsland.sub(rect(6.855154424660193e-10,6.855154424660193e-10).transl(-3.8192756626120863e-08,-3.990666713841345e-08,0))
hIsland = hIsland.add(rect(1.9225489265937266e-09,1.9225489265937266e-09).transl(1.0090559141321719e-07,-3.22703804790122e-08,0))
hIsland = hIsland.add(rect(8.081255350205596e-10,8.081255350205596e-10).transl(6.90929580919423e-08,3.781789791975582e-08,0))
hIsland = hIsland.add(rect(9.661047956809001e-09,9.661047956809001e-09).transl(-3.219145342517805e-08,-3.999332934917644e-08,0))
hIsland = hIsland.sub(rect(3.1691356548949955e-09,3.1691356548949955e-09).transl(-8.846637458986999e-08,-3.4931175255091115e-08,0))
hIsland = hIsland.add(rect(1.5211269003596263e-10,1.5211269003596263e-10).transl(2.105701919261932e-09,4e-08,0))
hIsland = hIsland.add(rect(1.8199086858192837e-09,1.8199086858192837e-09).transl(9.747437469137682e-08,-3.307770104870532e-08,0))
hIsland = hIsland.add(rect(5.652210052593076e-10,5.652210052593076e-10).transl(-1.3893147311532556e-07,1.6779399290416637e-08,0))
hIsland = hIsland.add(rect(6.9105316757089995e-09,6.9105316757089995e-09).transl(-1.3110234838686022e-07,2.1546629410709195e-08,0))
hIsland = hIsland.add(rect(4.23734346142395e-09,4.23734346142395e-09).transl(-1.7714342954056996e-09,4e-08,0))
hIsland = hIsland.add(rect(6.225373567871506e-09,6.225373567871506e-09).transl(1.1519343086857791e-07,2.8170274595042437e-08,0))
hIsland = hIsland.sub(rect(1.0497368033838283e-09,1.0497368033838283e-09).transl(-1.0104552542831044e-07,3.223616553675097e-08,0))
hIsland = hIsland.add(rect(2.033106146827326e-09,2.033106146827326e-09).transl(-2.9616720241727106e-08,-4e-08,0))
hIsland = hIsland.add(rect(7.281235326255914e-09,7.281235326255914e-09).transl(-2.0484686503379233e-08,4e-08,0))
hIsland = hIsland.sub(rect(5.245994511607197e-09,5.245994511607197e-09).transl(-1.362444500589725e-07,1.8595449956213906e-08,0))
hIsland = hIsland.add(rect(2.149803411484853e-09,2.149803411484853e-09).transl(-6.710902781300875e-08,3.8039336445277784e-08,0))
hIsland = hIsland.add(rect(3.966976910606087e-09,3.966976910606087e-09).transl(1.0141201965958855e-07,3.214606153194188e-08,0))
hIsland = hIsland.add(rect(2.0257096672350107e-09,2.0257096672350107e-09).transl(-8.897594924080234e-08,-3.4835864997547676e-08,0))
hIsland = hIsland.sub(rect(5.386674333199144e-09,5.386674333199144e-09).transl(1.319671220300251e-08,4e-08,0))
hIsland = hIsland.sub(rect(6.206263503713815e-09,6.206263503713815e-09).transl(-3.789199994228416e-08,-3.991340117041029e-08,0))
hIsland = hIsland.add(rect(7.915217078211626e-09,7.915217078211626e-09).transl(-3.3305495973818515e-08,3.998482169852715e-08,0))
hIsland = hIsland.sub(rect(3.609076637891957e-09,3.609076637891957e-09).transl(-4.814344737356185e-08,-3.9540155843849e-08,0))
hIsland = hIsland.add(rect(7.784690242044284e-09,7.784690242044284e-09).transl(1.1575186779544856e-07,2.7981377079907816e-08,0))
hIsland = hIsland.sub(rect(9.733672462666648e-09,9.733672462666648e-09).transl(2.618668074767712e-08,4e-08,0))
hIsland = hIsland.sub(rect(6.030422105930135e-09,6.030422105930135e-09).transl(-5.94493067192497e-08,-3.877676614468393e-08,0))
hIsland = hIsland.add(rect(7.360162638784781e-09,7.360162638784781e-09).transl(-1.360891413255611e-07,1.869371282545471e-08,0))
hIsland = hIsland.add(rect(3.996518827337288e-09,3.996518827337288e-09).transl(7.660857291332246e-08,3.685955466509706e-08,0))
hIsland = hIsland.sub(rect(2.7612448481260965e-09,2.7612448481260965e-09).transl(-1.0617543922842218e-07,-3.090721321481976e-08,0))
hIsland = hIsland.sub(rect(5.315863437789394e-09,5.315863437789394e-09).transl(6.573414739995456e-08,-3.81853239836085e-08,0))
hIsland = hIsland.sub(rect(5.115306439209207e-09,5.115306439209207e-09).transl(-8.830309229568934e-08,-3.496148583919856e-08,0))
hIsland = hIsland.add(rect(8.09346062159374e-10,8.09346062159374e-10).transl(1.420781149092272e-07,-1.4292562783933281e-08,0))
hIsland = hIsland.add(rect(7.393784116910352e-09,7.393784116910352e-09).transl(-6.500624359226444e-08,-3.8260166273610707e-08,0))
hIsland = hIsland.add(rect(7.969952994759653e-09,7.969952994759653e-09).transl(-3.4330155341288034e-08,3.9973949509816615e-08,0))
hIsland = hIsland.sub(rect(6.992042220048977e-09,6.992042220048977e-09).transl(1.3187902678633367e-07,2.1136235082250757e-08,0))
hIsland = hIsland.add(rect(9.467780108131239e-09,9.467780108131239e-09).transl(-3.936506887471028e-08,-3.9878002130068787e-08,0))
hIsland = hIsland.sub(rect(2.4554067816284564e-09,2.4554067816284564e-09).transl(3.0373492601129146e-08,-3.9999806254082037e-08,0))
hIsland = hIsland.add(rect(7.097517115142185e-09,7.097517115142185e-09).transl(-6.178562040075558e-08,-3.857125345201912e-08,0))


    vIsland := hIsland.rotz(pi / 2)
    vIslands := Universe().Inverse()

    hIslands := Universe().Inverse()
    hIslands = hIslands.add(hIsland.transl(-a/2, a, 0))
    hIslands = hIslands.add(hIsland.transl(-a/2, -a, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, a, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, -a, 0))
    hIslands = hIslands.add(hIsland.transl(-a/2, 0, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, 0, 0))

    vIslands = vIslands.add(vIsland.transl(-a, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(a, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(-a, -a/2, 0))
    vIslands = vIslands.add(vIsland.transl(a, -a/2, 0))
    vIslands = vIslands.add(vIsland.transl(0, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(0, -a/2, 0))

    DefRegion(1, hIslands)
    DefRegion(2, vIslands)
    TableAdd(m_full.Region(1))
    TableAdd(m_full.Region(2))
    setgeom(hIslands.add(vIslands))
    save(m)


    r2o2 := sqrt(2) / 2
    m = RandomMagSeed(4)
    B_ext = vector(Bmax*r2o2, Bmax*r2o2, 0)
    relax()
    minimize()

    for B := Bmax; B >= -Bmax; B -= Bstep {
        B_ext = vector(B*r2o2, B*r2o2, 0)
        minimize()
        tablesave()
    }

    