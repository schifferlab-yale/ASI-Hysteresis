
    randSeed(2)
    ThermSeed(2)


    resolution := 2e-09
    zResolution := 5e-09
    a := 3.2e-07

    gridSize := 320 //2*a/resolution
    gridDepth := 5 //25/zResolution

    SetCellsize(resolution,resolution,zResolution)
    SetGridsize(gridSize,gridSize,gridDepth)

    SetPBC(16, 16, 0)


    Msat = 700e3
    Aex = 13e-12
    alpha = 0.2
    Bmax := 0.1
    Bstep := Bmax / 500.0


    TableAdd(B_ext)
    TableAdd(m_full)


    islandWidth := 8e-08
    islandLength := 1.8000000000000002e-07
    ellipseConstant:=7.200000000000001e-08


    hIsland := rect(islandLength-2*ellipseConstant, islandWidth)
    hIsland = hIsland.add(ellipse(ellipseConstant*2,islandWidth).transl(islandLength/2-ellipseConstant, 0, 0))
    hIsland = hIsland.add(ellipse(ellipseConstant*2,islandWidth).transl(-islandLength/2+ellipseConstant, 0, 0))
    
    hIsland = hIsland.add(rect(6.202829277933325e-09,6.202829277933325e-09).transl(-5.452536527911619e-08,-3.4470857664939567e-08,0))
hIsland = hIsland.sub(rect(7.99300470888659e-09,7.99300470888659e-09).transl(-1.4170068632867885e-08,-4e-08,0))
hIsland = hIsland.sub(rect(6.667562981256022e-09,6.667562981256022e-09).transl(1.8667734757332158e-08,3.9998279786675376e-08,0))
hIsland = hIsland.add(rect(3.777780141731311e-09,3.777780141731311e-09).transl(-5.334254266237114e-08,-3.4849343645441134e-08,0))
hIsland = hIsland.add(rect(8.972885083790084e-09,8.972885083790084e-09).transl(8.409360765297212e-08,-1.586629150092358e-08,0))
hIsland = hIsland.sub(rect(8.579514913593432e-09,8.579514913593432e-09).transl(-2.2671524435585313e-08,-3.9915716989583305e-08,0))
hIsland = hIsland.sub(rect(7.652205958167425e-10,7.652205958167425e-10).transl(3.874514572322056e-08,3.8303687928535675e-08,0))
hIsland = hIsland.add(rect(9.904692719780662e-10,9.904692719780662e-10).transl(-3.254170325521615e-08,3.917568401491139e-08,0))
hIsland = hIsland.sub(rect(2.153405465855137e-09,2.153405465855137e-09).transl(4.6825509752450465e-09,4e-08,0))
hIsland = hIsland.add(rect(9.003622608456778e-09,9.003622608456778e-09).transl(4.018442150102445e-08,3.805393931144043e-08,0))
hIsland = hIsland.add(rect(3.1637894939603918e-09,3.1637894939603918e-09).transl(7.87562069902921e-08,-2.1464033310938575e-08,0))
hIsland = hIsland.add(rect(5.832134816858733e-09,5.832134816858733e-09).transl(-5.4658069671517144e-08,-3.442735206717862e-08,0))
hIsland = hIsland.add(rect(8.032362391346673e-09,8.032362391346673e-09).transl(4.5333528145022327e-08,3.700549775281676e-08,0))
hIsland = hIsland.add(rect(9.791352292999393e-09,9.791352292999393e-09).transl(1.3376425211729118e-08,-4e-08,0))
hIsland = hIsland.add(rect(2.3053957163913086e-09,2.3053957163913086e-09).transl(7.611479368492334e-08,2.3613860983389357e-08,0))
hIsland = hIsland.sub(rect(5.838098217163391e-09,5.838098217163391e-09).transl(2.4454911645750706e-08,3.983892768574302e-08,0))
hIsland = hIsland.add(rect(2.3521264377111185e-09,2.3521264377111185e-09).transl(-3.918373146049452e-08,-3.8229527408368226e-08,0))
hIsland = hIsland.add(rect(3.84613710369163e-09,3.84613710369163e-09).transl(-1.3770425992539437e-08,-4e-08,0))
hIsland = hIsland.sub(rect(3.116178470861821e-09,3.116178470861821e-09).transl(4.351091449006752e-08,-3.740499587795423e-08,0))
hIsland = hIsland.add(rect(4.187132792306316e-09,4.187132792306316e-09).transl(-5.346333782217006e-08,-3.481144833733281e-08,0))
hIsland = hIsland.add(rect(3.874855325737807e-09,3.874855325737807e-09).transl(-7.971017370520466e-08,2.060695122197e-08,0))
hIsland = hIsland.sub(rect(9.7601907764271e-09,9.7601907764271e-09).transl(6.857951045079887e-08,-2.8467618178203425e-08,0))
hIsland = hIsland.sub(rect(2.0931556218531312e-09,2.0931556218531312e-09).transl(7.235272165666815e-08,2.6233646572749622e-08,0))
hIsland = hIsland.sub(rect(2.451076396472245e-09,2.451076396472245e-09).transl(-2.549705615324136e-08,-3.978256546697692e-08,0))
hIsland = hIsland.sub(rect(9.813677847313377e-09,9.813677847313377e-09).transl(2.4639408168327982e-09,4e-08,0))
hIsland = hIsland.add(rect(6.145338469625664e-09,6.145338469625664e-09).transl(-7.951657272637416e-08,-2.078484193640187e-08,0))
hIsland = hIsland.add(rect(9.287098404875726e-09,9.287098404875726e-09).transl(-1.5722408997107616e-08,-4e-08,0))
hIsland = hIsland.sub(rect(5.1303358476525365e-09,5.1303358476525365e-09).transl(-5.0652937520861636e-08,-3.564998602348828e-08,0))
hIsland = hIsland.sub(rect(8.68801810566765e-09,8.68801810566765e-09).transl(1.98962970997637e-08,3.998612435764293e-08,0))
hIsland = hIsland.sub(rect(5.078699739420003e-09,5.078699739420003e-09).transl(7.208989425372654e-08,-2.6400777086046614e-08,0))
hIsland = hIsland.add(rect(7.56340107171172e-09,7.56340107171172e-09).transl(8.633036834152918e-08,1.260708161653978e-08,0))
hIsland = hIsland.add(rect(3.2178059974729114e-10,3.2178059974729114e-10).transl(7.3384307261388e-08,2.5559048729715128e-08,0))
hIsland = hIsland.sub(rect(7.641380506771467e-09,7.641380506771467e-09).transl(1.1277727800152603e-08,4e-08,0))
hIsland = hIsland.add(rect(6.519158980133421e-10,6.519158980133421e-10).transl(8.683683242874944e-08,1.1725914389261132e-08,0))
hIsland = hIsland.sub(rect(6.371393927683228e-09,6.371393927683228e-09).transl(2.868747764224961e-08,-3.955687350194519e-08,0))
hIsland = hIsland.add(rect(7.910241910377519e-09,7.910241910377519e-09).transl(4.635320609795312e-09,4e-08,0))
hIsland = hIsland.add(rect(4.308608909349271e-09,4.308608909349271e-09).transl(4.421867748669516e-09,4e-08,0))
hIsland = hIsland.sub(rect(2.7638501083106416e-09,2.7638501083106416e-09).transl(2.2919680699617292e-08,3.9906513986873244e-08,0))
hIsland = hIsland.sub(rect(3.077123346211864e-09,3.077123346211864e-09).transl(-1.0789999684069874e-08,4e-08,0))
hIsland = hIsland.add(rect(1.54701999308135e-09,1.54701999308135e-09).transl(-5.0627947806390065e-08,-3.565704708430973e-08,0))
hIsland = hIsland.sub(rect(9.551598160423437e-09,9.551598160423437e-09).transl(-1.7199483002946175e-08,-4e-08,0))
hIsland = hIsland.add(rect(9.744548591694484e-09,9.744548591694484e-09).transl(6.104432729372325e-08,3.2064681388412084e-08,0))
hIsland = hIsland.sub(rect(8.014735807631242e-09,8.014735807631242e-09).transl(6.052827709458662e-08,3.227651387545575e-08,0))
hIsland = hIsland.sub(rect(2.9607129824330482e-09,2.9607129824330482e-09).transl(-4.918465050076542e-08,-3.605344786317344e-08,0))
hIsland = hIsland.sub(rect(1.399680076562424e-09,1.399680076562424e-09).transl(6.352226568432833e-08,-3.099045714810589e-08,0))
hIsland = hIsland.sub(rect(1.1867975170942202e-09,1.1867975170942202e-09).transl(-8.927336069818505e-09,-4e-08,0))
hIsland = hIsland.add(rect(6.450445953038553e-09,6.450445953038553e-09).transl(4.7842773248317076e-08,3.640228288208904e-08,0))
hIsland = hIsland.sub(rect(6.014779112493666e-09,6.014779112493666e-09).transl(-3.729751214339593e-09,4e-08,0))
hIsland = hIsland.sub(rect(9.625153570076501e-09,9.625153570076501e-09).transl(-8.816080524220269e-08,8.98320462640062e-09,0))
hIsland = hIsland.sub(rect(2.0702347256900213e-09,2.0702347256900213e-09).transl(-8.56431466311598e-08,-1.3703256279631196e-08,0))


    vIsland := hIsland.rotz(pi / 2)
    vIslands := Universe().Inverse()

    hIslands := Universe().Inverse()
    hIslands = hIslands.add(hIsland.transl(-a/2, a, 0))
    hIslands = hIslands.add(hIsland.transl(-a/2, -a, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, a, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, -a, 0))
    hIslands = hIslands.add(hIsland.transl(-a/2, 0, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, 0, 0))

    vIslands = vIslands.add(vIsland.transl(-a, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(a, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(-a, -a/2, 0))
    vIslands = vIslands.add(vIsland.transl(a, -a/2, 0))
    vIslands = vIslands.add(vIsland.transl(0, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(0, -a/2, 0))

    DefRegion(1, hIslands)
    DefRegion(2, vIslands)
    TableAdd(m_full.Region(1))
    TableAdd(m_full.Region(2))
    setgeom(hIslands.add(vIslands))
    save(m)


    r2o2 := sqrt(2) / 2
    m = RandomMagSeed(4)
    B_ext = vector(Bmax*r2o2, Bmax*r2o2, 0)
    relax()
    minimize()

    for B := Bmax; B >= -Bmax; B -= Bstep {
        B_ext = vector(B*r2o2, B*r2o2, 0)
        minimize()
        tablesave()
    }

    