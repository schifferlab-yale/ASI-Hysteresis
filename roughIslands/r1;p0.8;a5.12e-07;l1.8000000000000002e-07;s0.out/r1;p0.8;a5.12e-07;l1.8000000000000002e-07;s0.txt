
    randSeed(0)
    ThermSeed(0)


    resolution := 2e-09
    zResolution := 5e-09
    a := 5.12e-07

    gridSize := 512 //2*a/resolution
    gridDepth := 5 //25/zResolution

    SetCellsize(resolution,resolution,zResolution)
    SetGridsize(gridSize,gridSize,gridDepth)

    SetPBC(16, 16, 0)


    Msat = 700e3
    Aex = 13e-12
    alpha = 0.2
    Bmax := 0.1
    Bstep := Bmax / 500.0


    TableAdd(B_ext)
    TableAdd(m_full)


    islandWidth := 8e-08
    islandLength := 1.8000000000000002e-07
    ellipseConstant:=7.200000000000001e-08


    hIsland := rect(islandLength-2*ellipseConstant, islandWidth)
    hIsland = hIsland.add(ellipse(ellipseConstant*2,islandWidth).transl(islandLength/2-ellipseConstant, 0, 0))
    hIsland = hIsland.add(ellipse(ellipseConstant*2,islandWidth).transl(-islandLength/2+ellipseConstant, 0, 0))
    
    hIsland = hIsland.add(rect(2.0447776932915884e-10,2.0447776932915884e-10).transl(8.156872151206912e-08,1.8782524427363506e-08,0))
hIsland = hIsland.sub(rect(4.822957899568221e-09,4.822957899568221e-09).transl(-9.704286667326181e-09,4e-08,0))
hIsland = hIsland.add(rect(6.05227620045723e-09,6.05227620045723e-09).transl(6.852726911568752e-08,2.8496236895329173e-08,0))
hIsland = hIsland.sub(rect(8.213114478254496e-09,8.213114478254496e-09).transl(4.056147907927129e-09,-4e-08,0))
hIsland = hIsland.sub(rect(5.004764275959553e-09,5.004764275959553e-09).transl(-1.0991639123089355e-08,4e-08,0))
hIsland = hIsland.add(rect(6.966054758668161e-09,6.966054758668161e-09).transl(7.045597325299744e-08,2.7399484484656713e-08,0))
hIsland = hIsland.sub(rect(8.900397801502886e-09,8.900397801502886e-09).transl(9.408963339430332e-09,-4e-08,0))
hIsland = hIsland.sub(rect(3.1568792840853677e-11,3.1568792840853677e-11).transl(-1.388640209688953e-08,4e-08,0))
hIsland = hIsland.sub(rect(6.036484898576417e-09,6.036484898576417e-09).transl(5.201031185531678e-08,3.5256111839923105e-08,0))
hIsland = hIsland.sub(rect(6.334744154570451e-09,6.334744154570451e-09).transl(-5.196646213718542e-08,-3.526915664511646e-08,0))
hIsland = hIsland.add(rect(6.993450686906362e-09,6.993450686906362e-09).transl(5.2892797929409814e-08,3.498894293006559e-08,0))
hIsland = hIsland.add(rect(4.213415027737395e-09,4.213415027737395e-09).transl(-6.5268842844640615e-09,4e-08,0))
hIsland = hIsland.sub(rect(8.662399528401107e-09,8.662399528401107e-09).transl(4.984217414928629e-08,-3.5875625109392425e-08,0))
hIsland = hIsland.add(rect(8.706124788374867e-09,8.706124788374867e-09).transl(-1.1466195271492983e-08,4e-08,0))
hIsland = hIsland.add(rect(5.522828728967421e-09,5.522828728967421e-09).transl(-6.001920375070922e-08,-3.248164969201739e-08,0))
hIsland = hIsland.add(rect(7.0415575761412366e-09,7.0415575761412366e-09).transl(-6.585039493134356e-08,2.9888371045258186e-08,0))
hIsland = hIsland.add(rect(9.499675266335271e-09,9.499675266335271e-09).transl(-8.175388020121368e-08,-1.8587819250035897e-08,0))
hIsland = hIsland.sub(rect(3.7618976156351124e-10,3.7618976156351124e-10).transl(-6.863643979851923e-08,2.8436364762476422e-08,0))
hIsland = hIsland.add(rect(2.18947648480043e-09,2.18947648480043e-09).transl(-1.0923059932160642e-08,4e-08,0))
hIsland = hIsland.sub(rect(7.644807769104043e-09,7.644807769104043e-09).transl(-6.653272921267093e-08,2.9546856463999434e-08,0))
hIsland = hIsland.sub(rect(4.236780869804396e-09,4.236780869804396e-09).transl(2.6645077606615545e-08,3.9710614594513004e-08,0))
hIsland = hIsland.sub(rect(9.084726114610405e-09,9.084726114610405e-09).transl(3.1878384593367225e-08,3.924987395229657e-08,0))
hIsland = hIsland.sub(rect(3.868990524583487e-09,3.868990524583487e-09).transl(5.537548577198917e-08,3.418844411343517e-08,0))
hIsland = hIsland.add(rect(6.056316951165762e-09,6.056316951165762e-09).transl(1.878937028012797e-08,3.999759597158854e-08,0))
hIsland = hIsland.sub(rect(2.3993414992258257e-09,2.3993414992258257e-09).transl(-3.2626008449831676e-08,3.916599635685449e-08,0))
hIsland = hIsland.add(rect(8.139171294946523e-09,8.139171294946523e-09).transl(-7.332959480360446e-08,2.559559628204871e-08,0))
hIsland = hIsland.sub(rect(3.628542856412029e-09,3.628542856412029e-09).transl(-9.025051655222142e-09,-4e-08,0))
hIsland = hIsland.add(rect(8.961984637191423e-09,8.961984637191423e-09).transl(-2.4046516184360326e-08,-3.9858699663923416e-08,0))
hIsland = hIsland.sub(rect(6.766218955616904e-09,6.766218955616904e-09).transl(-6.141907852644337e-08,3.190835458882544e-08,0))
hIsland = hIsland.sub(rect(2.296008388392502e-09,2.296008388392502e-09).transl(-7.239549794861983e-08,2.6206267526908173e-08,0))
hIsland = hIsland.add(rect(6.5016776087584116e-09,6.5016776087584116e-09).transl(-7.72552367526946e-08,2.272226920249227e-08,0))
hIsland = hIsland.add(rect(1.4792329525359382e-09,1.4792329525359382e-09).transl(4.309722379898642e-08,-3.749127206078337e-08,0))
hIsland = hIsland.sub(rect(6.401252746290106e-09,6.401252746290106e-09).transl(-4.0067824094786245e-08,3.807485779632488e-08,0))
hIsland = hIsland.add(rect(3.837128034447253e-09,3.837128034447253e-09).transl(6.286651369527623e-08,3.128422051678903e-08,0))
hIsland = hIsland.add(rect(3.177985100234211e-09,3.177985100234211e-09).transl(-5.420615743622327e-09,4e-08,0))
hIsland = hIsland.sub(rect(3.127718670862275e-09,3.127718670862275e-09).transl(-2.7555843820245294e-08,-3.964614256173786e-08,0))
hIsland = hIsland.add(rect(3.9430463619633635e-09,3.9430463619633635e-09).transl(6.097660202432136e-08,-3.209270752153337e-08,0))
hIsland = hIsland.add(rect(4.203701984920459e-09,4.203701984920459e-09).transl(-3.557673889562668e-08,-3.8789787418358056e-08,0))
hIsland = hIsland.add(rect(8.490551054922906e-09,8.490551054922906e-09).transl(-4.925172188616035e-08,-3.603551865418275e-08,0))
hIsland = hIsland.add(rect(5.712570822589699e-09,5.712570822589699e-09).transl(-3.431102945797923e-08,3.8960055192770776e-08,0))
hIsland = hIsland.sub(rect(4.848394821080016e-10,4.848394821080016e-10).transl(4.386476321650119e-08,-3.732991892353579e-08,0))
hIsland = hIsland.add(rect(2.759404741340756e-09,2.759404741340756e-09).transl(2.2029980887532312e-08,-3.993729365002479e-08,0))
hIsland = hIsland.sub(rect(6.934565500750516e-09,6.934565500750516e-09).transl(-5.7858483556952e-08,3.331157293681506e-08,0))
hIsland = hIsland.add(rect(7.325729978573985e-09,7.325729978573985e-09).transl(-6.283406035750129e-08,3.129857721621285e-08,0))
hIsland = hIsland.add(rect(5.313655689012462e-09,5.313655689012462e-09).transl(2.5651658930226244e-08,3.9773479421763227e-08,0))
hIsland = hIsland.sub(rect(9.499632639211386e-10,9.499632639211386e-10).transl(-3.2904632345197342e-09,-4e-08,0))
hIsland = hIsland.sub(rect(3.9376066081956705e-09,3.9376066081956705e-09).transl(-6.659843032812983e-08,2.9513506897616418e-08,0))
hIsland = hIsland.sub(rect(3.415710013461747e-09,3.415710013461747e-09).transl(-6.685342627698551e-08,-2.9383284179908587e-08,0))
hIsland = hIsland.sub(rect(9.743977890143652e-10,9.743977890143652e-10).transl(-1.3490463987363518e-08,4e-08,0))
hIsland = hIsland.sub(rect(2.686340644276469e-09,2.686340644276469e-09).transl(-4.6301566962447904e-08,-3.678021688567689e-08,0))


    vIsland := hIsland.rotz(pi / 2)
    vIslands := Universe().Inverse()

    hIslands := Universe().Inverse()
    hIslands = hIslands.add(hIsland.transl(-a/2, a, 0))
    hIslands = hIslands.add(hIsland.transl(-a/2, -a, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, a, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, -a, 0))
    hIslands = hIslands.add(hIsland.transl(-a/2, 0, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, 0, 0))

    vIslands = vIslands.add(vIsland.transl(-a, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(a, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(-a, -a/2, 0))
    vIslands = vIslands.add(vIsland.transl(a, -a/2, 0))
    vIslands = vIslands.add(vIsland.transl(0, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(0, -a/2, 0))

    DefRegion(1, hIslands)
    DefRegion(2, vIslands)
    TableAdd(m_full.Region(1))
    TableAdd(m_full.Region(2))
    setgeom(hIslands.add(vIslands))
    save(m)


    r2o2 := sqrt(2) / 2
    m = RandomMagSeed(4)
    B_ext = vector(Bmax*r2o2, Bmax*r2o2, 0)
    relax()
    minimize()

    for B := Bmax; B >= -Bmax; B -= Bstep {
        B_ext = vector(B*r2o2, B*r2o2, 0)
        minimize()
        tablesave()
    }

    