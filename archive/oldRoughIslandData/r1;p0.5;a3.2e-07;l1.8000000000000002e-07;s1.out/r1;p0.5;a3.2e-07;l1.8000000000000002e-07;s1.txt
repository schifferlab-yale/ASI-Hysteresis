
    randSeed(1)
    ThermSeed(1)


    resolution := 2e-09
    zResolution := 5e-09
    a := 3.2e-07

    gridSize := 320 //2*a/resolution
    gridDepth := 5 //25/zResolution

    SetCellsize(resolution,resolution,zResolution)
    SetGridsize(gridSize,gridSize,gridDepth)

    SetPBC(16, 16, 0)


    Msat = 700e3
    Aex = 13e-12
    alpha = 0.2
    Bmax := 0.1
    Bstep := Bmax / 500.0


    TableAdd(B_ext)
    TableAdd(m_full)


    islandWidth := 8e-08
    islandLength := 1.8000000000000002e-07
    ellipseConstant:=4.5000000000000006e-08


    hIsland := rect(islandLength-2*ellipseConstant, islandWidth)
    hIsland = hIsland.add(ellipse(ellipseConstant*2,islandWidth).transl(islandLength/2-ellipseConstant, 0, 0))
    hIsland = hIsland.add(ellipse(ellipseConstant*2,islandWidth).transl(-islandLength/2+ellipseConstant, 0, 0))
    
    hIsland = hIsland.sub(rect(6.435255862611412e-09,6.435255862611412e-09).transl(1.9867118189191694e-08,-4e-08,0))
hIsland = hIsland.sub(rect(6.896974434170692e-09,6.896974434170692e-09).transl(1.510439926722881e-09,4e-08,0))
hIsland = hIsland.sub(rect(2.159854692876004e-09,2.159854692876004e-09).transl(7.408935381148998e-09,-4e-08,0))
hIsland = hIsland.add(rect(8.07182772979625e-09,8.07182772979625e-09).transl(4.002101842574443e-08,-4e-08,0))
hIsland = hIsland.sub(rect(8.299698670945828e-09,8.299698670945828e-09).transl(4.823330941938293e-08,3.9896614147115e-08,0))
hIsland = hIsland.add(rect(5.418940840897274e-09,5.418940840897274e-09).transl(6.834709275707203e-08,-3.4195236226365345e-08,0))
hIsland = hIsland.sub(rect(6.639796343278037e-09,6.639796343278037e-09).transl(5.343759400284814e-08,3.9290568163640875e-08,0))
hIsland = hIsland.sub(rect(9.238866192691165e-10,9.238866192691165e-10).transl(-3.4364234187898594e-08,-4e-08,0))
hIsland = hIsland.add(rect(4.189697377669726e-09,4.189697377669726e-09).transl(-6.618861786077885e-08,3.5288356818265735e-08,0))
hIsland = hIsland.sub(rect(3.1914462793540523e-09,3.1914462793540523e-09).transl(-3.158414897603705e-08,4e-08,0))
hIsland = hIsland.sub(rect(3.701774764690813e-09,3.701774764690813e-09).transl(2.8300349586408682e-08,4e-08,0))
hIsland = hIsland.add(rect(5.91940824669337e-10,5.91940824669337e-10).transl(2.779759508497638e-08,4e-08,0))
hIsland = hIsland.sub(rect(6.675810026500098e-09,6.675810026500098e-09).transl(-6.178916329595886e-08,-3.7111765751475597e-08,0))
hIsland = hIsland.sub(rect(6.711041116503788e-09,6.711041116503788e-09).transl(-4.7796810869276304e-08,-3.992266943707452e-08,0))
hIsland = hIsland.add(rect(8.645396176731477e-09,8.645396176731477e-09).transl(5.8658161190058804e-08,3.811307032638278e-08,0))
hIsland = hIsland.add(rect(1.035219887407165e-09,1.035219887407165e-09).transl(1.9396052585665983e-08,4e-08,0))
hIsland = hIsland.add(rect(8.749464725443141e-09,8.749464725443141e-09).transl(-4.4621702511925324e-08,-4e-08,0))
hIsland = hIsland.add(rect(4.2863122371154664e-09,4.2863122371154664e-09).transl(2.8628182154375075e-08,-4e-08,0))
hIsland = hIsland.add(rect(6.610403621747518e-10,6.610403621747518e-10).transl(6.933287902444703e-08,-3.36478318961843e-08,0))
hIsland = hIsland.add(rect(8.112770508918657e-09,8.112770508918657e-09).transl(4.3758845911943155e-08,-4e-08,0))
hIsland = hIsland.add(rect(9.000996115666038e-09,9.000996115666038e-09).transl(8.942223550308978e-08,-6.389187960259961e-09,0))
hIsland = hIsland.add(rect(9.247330788472854e-09,9.247330788472854e-09).transl(-1.3156445083713754e-08,4e-08,0))
hIsland = hIsland.sub(rect(8.649274005073071e-10,8.649274005073071e-10).transl(5.968169029483281e-08,-3.781120581265171e-08,0))
hIsland = hIsland.sub(rect(9.088772662628342e-09,9.088772662628342e-09).transl(-4.4283479466032165e-08,4e-08,0))
hIsland = hIsland.sub(rect(5.43799954276988e-09,5.43799954276988e-09).transl(1.9427971794002075e-08,-4e-08,0))
hIsland = hIsland.sub(rect(1.7872897853717752e-09,1.7872897853717752e-09).transl(-4.30729919567315e-08,4e-08,0))
hIsland = hIsland.sub(rect(3.61204464943777e-09,3.61204464943777e-09).transl(-5.921870427219002e-08,-3.7950751179878395e-08,0))
hIsland = hIsland.add(rect(6.034022818352636e-09,6.034022818352636e-09).transl(5.327496847404127e-08,3.9317886702096695e-08,0))
hIsland = hIsland.sub(rect(2.956666046022255e-09,2.956666046022255e-09).transl(-8.055944032290918e-08,2.451345739021519e-08,0))
hIsland = hIsland.sub(rect(3.09309906510297e-09,3.09309906510297e-09).transl(6.923680287048265e-08,3.370257577867638e-08,0))
hIsland = hIsland.add(rect(9.743897913023289e-09,9.743897913023289e-09).transl(8.578863872995843e-08,-1.689559984928645e-08,0))
hIsland = hIsland.add(rect(9.524426986996515e-10,9.524426986996515e-10).transl(-2.4773587293136687e-08,-4e-08,0))
hIsland = hIsland.add(rect(7.273004019945218e-10,7.273004019945218e-10).transl(-2.303087894390225e-08,4e-08,0))
hIsland = hIsland.sub(rect(3.0071051697574737e-09,3.0071051697574737e-09).transl(-7.328271015987449e-08,3.111223243709424e-08,0))
hIsland = hIsland.add(rect(2.6796030745981805e-10,2.6796030745981805e-10).transl(-5.2403060329121324e-08,3.9455000255308355e-08,0))
hIsland = hIsland.sub(rect(8.480897768385594e-09,8.480897768385594e-09).transl(6.345657890488755e-08,-3.648079157823938e-08,0))
hIsland = hIsland.add(rect(9.51958849771011e-09,9.51958849771011e-09).transl(5.2595494072326146e-08,-3.9426089949787034e-08,0))
hIsland = hIsland.add(rect(4.051955608080509e-09,4.051955608080509e-09).transl(-6.171963884355311e-08,3.713655736456697e-08,0))
hIsland = hIsland.add(rect(4.414184435294358e-09,4.414184435294358e-09).transl(-5.765148665836264e-08,-3.838662200435592e-08,0))
hIsland = hIsland.add(rect(7.648634951482671e-09,7.648634951482671e-09).transl(-8.740539801447458e-08,-1.3386035671538468e-08,0))
hIsland = hIsland.sub(rect(7.33686610933561e-09,7.33686610933561e-09).transl(-4.949182828554403e-08,-3.9800226848693415e-08,0))
hIsland = hIsland.add(rect(5.9873718316661145e-09,5.9873718316661145e-09).transl(-2.453716700400663e-08,4e-08,0))
hIsland = hIsland.add(rect(3.559756143758255e-09,3.559756143758255e-09).transl(-3.768993671739415e-08,4e-08,0))
hIsland = hIsland.add(rect(5.381526702846395e-10,5.381526702846395e-10).transl(1.909869655078385e-08,4e-08,0))
hIsland = hIsland.sub(rect(8.020918540713218e-09,8.020918540713218e-09).transl(-8.180431190505658e-08,2.3015917200901735e-08,0))
hIsland = hIsland.sub(rect(2.863291426275607e-09,2.863291426275607e-09).transl(-5.0695326322728456e-08,3.9678343833195625e-08,0))
hIsland = hIsland.sub(rect(2.748774608184679e-09,2.748774608184679e-09).transl(-4.053985446895345e-08,-4e-08,0))
hIsland = hIsland.sub(rect(1.453850092146367e-09,1.453850092146367e-09).transl(-2.4594832808475434e-08,-4e-08,0))
hIsland = hIsland.sub(rect(4.2050603712493807e-10,4.2050603712493807e-10).transl(-3.1734204771738975e-08,-4e-08,0))
hIsland = hIsland.sub(rect(4.0952694344770446e-09,4.0952694344770446e-09).transl(-7.660571490446611e-08,-2.8473301825421795e-08,0))


    vIsland := hIsland.rotz(pi / 2)
    vIslands := Universe().Inverse()

    hIslands := Universe().Inverse()
    hIslands = hIslands.add(hIsland.transl(-a/2, a, 0))
    hIslands = hIslands.add(hIsland.transl(-a/2, -a, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, a, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, -a, 0))
    hIslands = hIslands.add(hIsland.transl(-a/2, 0, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, 0, 0))

    vIslands = vIslands.add(vIsland.transl(-a, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(a, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(-a, -a/2, 0))
    vIslands = vIslands.add(vIsland.transl(a, -a/2, 0))
    vIslands = vIslands.add(vIsland.transl(0, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(0, -a/2, 0))

    DefRegion(1, hIslands)
    DefRegion(2, vIslands)
    TableAdd(m_full.Region(1))
    TableAdd(m_full.Region(2))
    setgeom(hIslands.add(vIslands))
    save(m)


    r2o2 := sqrt(2) / 2
    m = RandomMagSeed(4)
    B_ext = vector(Bmax*r2o2, Bmax*r2o2, 0)
    relax()
    minimize()

    for B := Bmax; B >= -Bmax; B -= Bstep {
        B_ext = vector(B*r2o2, B*r2o2, 0)
        minimize()
        tablesave()
    }

    