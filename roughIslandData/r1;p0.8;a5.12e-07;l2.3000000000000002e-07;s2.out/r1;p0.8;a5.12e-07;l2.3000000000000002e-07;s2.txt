
    randSeed(2)
    ThermSeed(2)


    resolution := 2e-09
    zResolution := 5e-09
    a := 5.12e-07

    gridSize := 512 //2*a/resolution
    gridDepth := 5 //25/zResolution

    SetCellsize(resolution,resolution,zResolution)
    SetGridsize(gridSize,gridSize,gridDepth)

    SetPBC(16, 16, 0)


    Msat = 700e3
    Aex = 13e-12
    alpha = 0.2
    Bmax := 0.1
    Bstep := Bmax / 500.0


    TableAdd(B_ext)
    TableAdd(m_full)


    islandWidth := 8e-08
    islandLength := 2.3000000000000002e-07
    ellipseConstant:=9.200000000000002e-08


    hIsland := rect(islandLength-2*ellipseConstant, islandWidth)
    hIsland = hIsland.add(ellipse(ellipseConstant*2,islandWidth).transl(islandLength/2-ellipseConstant, 0, 0))
    hIsland = hIsland.add(ellipse(ellipseConstant*2,islandWidth).transl(-islandLength/2+ellipseConstant, 0, 0))
    
    hIsland = hIsland.sub(rect(9.148485742600552e-09,9.148485742600552e-09).transl(-9.83940055186592e-08,2.29231638892674e-08,0))
hIsland = hIsland.add(rect(8.55834948975467e-09,8.55834948975467e-09).transl(5.6553132320517406e-08,-3.7244878389567315e-08,0))
hIsland = hIsland.add(rect(3.614710481901251e-09,3.614710481901251e-09).transl(4.5399547937787466e-08,3.879630351933322e-08,0))
hIsland = hIsland.add(rect(9.194679359832529e-09,9.194679359832529e-09).transl(2.059769289421555e-08,-4e-08,0))
hIsland = hIsland.sub(rect(3.825114244056256e-09,3.825114244056256e-09).transl(-6.972344196780238e-09,4e-08,0))
hIsland = hIsland.add(rect(5.013294269494683e-10,5.013294269494683e-10).transl(-1.0906727187523798e-07,1.4131603376119004e-08,0))
hIsland = hIsland.sub(rect(1.3818931946472967e-09,1.3818931946472967e-09).transl(1.1286840486011803e-08,-4e-08,0))
hIsland = hIsland.sub(rect(6.179939424818582e-09,6.179939424818582e-09).transl(-8.418467526511607e-08,-2.987192419234447e-08,0))
hIsland = hIsland.sub(rect(6.7365769750955185e-09,6.7365769750955185e-09).transl(2.27828148007045e-08,4e-08,0))
hIsland = hIsland.sub(rect(2.0507957841250924e-10,2.0507957841250924e-10).transl(5.534066665946117e-08,-3.744707993749708e-08,0))
hIsland = hIsland.add(rect(5.176199443032231e-09,5.176199443032231e-09).transl(-6.190766526636202e-08,3.6246878709297013e-08,0))
hIsland = hIsland.sub(rect(6.5395498006885226e-09,6.5395498006885226e-09).transl(-4.103346401444619e-08,-3.9224028590080814e-08,0))
hIsland = hIsland.add(rect(3.438870172899893e-09,3.438870172899893e-09).transl(2.386980690698606e-08,3.999821223780062e-08,0))
hIsland = hIsland.add(rect(9.94726702680645e-09,9.94726702680645e-09).transl(-5.624458251249924e-08,-3.729714568555019e-08,0))
hIsland = hIsland.add(rect(4.228972345958393e-10,4.228972345958393e-10).transl(-9.104637727968035e-09,-4e-08,0))
hIsland = hIsland.add(rect(8.289452661316256e-09,8.289452661316256e-09).transl(-1.0475912699570582e-07,1.834063919051987e-08,0))
hIsland = hIsland.add(rect(7.9882972169723e-09,7.9882972169723e-09).transl(5.6900173158886155e-08,3.718542476167952e-08,0))
hIsland = hIsland.sub(rect(4.93367800635617e-09,4.93367800635617e-09).transl(-2.2061317942222942e-09,-4e-08,0))
hIsland = hIsland.add(rect(5.090427224917762e-09,5.090427224917762e-09).transl(-8.398518652250955e-08,-2.994893898103469e-08,0))
hIsland = hIsland.add(rect(6.236163258005211e-09,6.236163258005211e-09).transl(1.9898449426896375e-08,4e-08,0))
hIsland = hIsland.sub(rect(6.32839042526386e-09,6.32839042526386e-09).transl(-6.801914227506354e-08,-3.488375735477314e-08,0))
hIsland = hIsland.add(rect(6.1382402226561186e-09,6.1382402226561186e-09).transl(-1.1318338049430648e-07,7.90967298762122e-09,0))
hIsland = hIsland.add(rect(3.140922121077282e-09,3.140922121077282e-09).transl(-7.735888788080092e-08,3.227103820863e-08,0))
hIsland = hIsland.add(rect(9.306795916715242e-09,9.306795916715242e-09).transl(1.740522186722068e-08,-4e-08,0))
hIsland = hIsland.add(rect(7.829366313300964e-09,7.829366313300964e-09).transl(-6.648580182416986e-08,-3.5249542596367464e-08,0))
hIsland = hIsland.sub(rect(8.825153507968723e-09,8.825153507968723e-09).transl(-1.1205669777792985e-08,-4e-08,0))
hIsland = hIsland.sub(rect(4.913071335146498e-09,4.913071335146498e-09).transl(7.848133367418035e-08,3.1907894424481075e-08,0))
hIsland = hIsland.add(rect(2.303359136780221e-09,2.303359136780221e-09).transl(-1.1322502090201299e-07,-7.819388476702536e-09,0))
hIsland = hIsland.add(rect(3.6231337092546067e-09,3.6231337092546067e-09).transl(-1.8512032737300098e-08,-4e-08,0))
hIsland = hIsland.sub(rect(6.601750057894067e-09,6.601750057894067e-09).transl(1.1146158630302585e-07,-1.0986740149899786e-08,0))
hIsland = hIsland.sub(rect(7.981738928559992e-09,7.981738928559992e-09).transl(1.0937834386829074e-07,-1.3768142940585195e-08,0))
hIsland = hIsland.add(rect(8.173591757571109e-09,8.173591757571109e-09).transl(1.087531245903236e-07,-1.4488125787906721e-08,0))
hIsland = hIsland.add(rect(7.46832341196565e-09,7.46832341196565e-09).transl(8.321550896991961e-08,3.024191210127611e-08,0))
hIsland = hIsland.sub(rect(3.7328744387827516e-10,3.7328744387827516e-10).transl(-1.073206726535649e-07,1.5998724921135e-08,0))
hIsland = hIsland.add(rect(4.244639532487166e-09,4.244639532487166e-09).transl(-6.17843200054364e-08,3.6271858729241935e-08,0))
hIsland = hIsland.add(rect(1.7797617130707211e-09,1.7797617130707211e-09).transl(8.197834942129935e-08,3.0699329437142314e-08,0))
hIsland = hIsland.sub(rect(5.198495791780924e-09,5.198495791780924e-09).transl(7.25524431126438e-08,3.370211826196842e-08,0))
hIsland = hIsland.sub(rect(8.382646504126992e-09,8.382646504126992e-09).transl(-4.320129843501175e-08,-3.9023785925585135e-08,0))
hIsland = hIsland.add(rect(3.1441812794021107e-09,3.1441812794021107e-09).transl(-3.9662123403423076e-08,3.933851353572232e-08,0))
hIsland = hIsland.sub(rect(3.0372635134131023e-09,3.0372635134131023e-09).transl(7.427969962692594e-08,-3.321008457702121e-08,0))
hIsland = hIsland.sub(rect(6.877084009744294e-11,6.877084009744294e-11).transl(-9.51666278012712e-09,4e-08,0))
hIsland = hIsland.add(rect(9.50017578619315e-09,9.50017578619315e-09).transl(-8.93729632834664e-08,2.7698859090053976e-08,0))
hIsland = hIsland.add(rect(5.743360401917397e-09,5.743360401917397e-09).transl(-3.8911422952802685e-08,3.9397222464582745e-08,0))
hIsland = hIsland.sub(rect(2.70085984705553e-09,2.70085984705553e-09).transl(3.542725760126066e-08,-3.963339388535653e-08,0))
hIsland = hIsland.add(rect(6.845293300314548e-09,6.845293300314548e-09).transl(-2.9317849224301938e-08,3.9905570914534375e-08,0))
hIsland = hIsland.add(rect(8.314321680521264e-11,8.314321680521264e-11).transl(-4.7906683600297896e-08,3.850627109222731e-08,0))
hIsland = hIsland.add(rect(1.7110651139073585e-09,1.7110651139073585e-09).transl(5.3632721226555236e-08,3.771757646930154e-08,0))
hIsland = hIsland.sub(rect(2.6618913047521276e-09,2.6618913047521276e-09).transl(1.9178405371749494e-08,4e-08,0))
hIsland = hIsland.sub(rect(6.047363116918359e-09,6.047363116918359e-09).transl(2.9405230644718845e-08,-3.990293757725751e-08,0))
hIsland = hIsland.add(rect(1.8715932267140422e-09,1.8715932267140422e-09).transl(-5.771917655203798e-08,3.70423014192233e-08,0))


    vIsland := hIsland.rotz(pi / 2)
    vIslands := Universe().Inverse()

    hIslands := Universe().Inverse()
    hIslands = hIslands.add(hIsland.transl(-a/2, a, 0))
    hIslands = hIslands.add(hIsland.transl(-a/2, -a, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, a, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, -a, 0))
    hIslands = hIslands.add(hIsland.transl(-a/2, 0, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, 0, 0))

    vIslands = vIslands.add(vIsland.transl(-a, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(a, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(-a, -a/2, 0))
    vIslands = vIslands.add(vIsland.transl(a, -a/2, 0))
    vIslands = vIslands.add(vIsland.transl(0, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(0, -a/2, 0))

    DefRegion(1, hIslands)
    DefRegion(2, vIslands)
    TableAdd(m_full.Region(1))
    TableAdd(m_full.Region(2))
    setgeom(hIslands.add(vIslands))
    save(m)


    r2o2 := sqrt(2) / 2
    m = RandomMagSeed(4)
    B_ext = vector(Bmax*r2o2, Bmax*r2o2, 0)
    relax()
    minimize()

    for B := Bmax; B >= -Bmax; B -= Bstep {
        B_ext = vector(B*r2o2, B*r2o2, 0)
        minimize()
        tablesave()
    }

    