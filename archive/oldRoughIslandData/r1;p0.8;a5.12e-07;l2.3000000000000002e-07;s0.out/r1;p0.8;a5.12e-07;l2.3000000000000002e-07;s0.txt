
    randSeed(0)
    ThermSeed(0)


    resolution := 2e-09
    zResolution := 5e-09
    a := 5.12e-07

    gridSize := 512 //2*a/resolution
    gridDepth := 5 //25/zResolution

    SetCellsize(resolution,resolution,zResolution)
    SetGridsize(gridSize,gridSize,gridDepth)

    SetPBC(16, 16, 0)


    Msat = 700e3
    Aex = 13e-12
    alpha = 0.2
    Bmax := 0.1
    Bstep := Bmax / 500.0


    TableAdd(B_ext)
    TableAdd(m_full)


    islandWidth := 8e-08
    islandLength := 2.3000000000000002e-07
    ellipseConstant:=9.200000000000002e-08


    hIsland := rect(islandLength-2*ellipseConstant, islandWidth)
    hIsland = hIsland.add(ellipse(ellipseConstant*2,islandWidth).transl(islandLength/2-ellipseConstant, 0, 0))
    hIsland = hIsland.add(ellipse(ellipseConstant*2,islandWidth).transl(-islandLength/2+ellipseConstant, 0, 0))
    
    hIsland = hIsland.sub(rect(3.1830630483409082e-09,3.1830630483409082e-09).transl(1.0723890998544779e-07,1.6079939976655993e-08,0))
hIsland = hIsland.sub(rect(7.293660040362437e-10,7.293660040362437e-10).transl(8.3190326184931e-08,-3.025138730044357e-08,0))
hIsland = hIsland.add(rect(6.7009598932791835e-09,6.7009598932791835e-09).transl(7.721801535935955e-08,3.231580582828221e-08,0))
hIsland = hIsland.add(rect(6.3913277540715395e-09,6.3913277540715395e-09).transl(-8.749180710042211e-08,-2.8526533322292977e-08,0))
hIsland = hIsland.sub(rect(2.823388788826211e-09,2.823388788826211e-09).transl(-8.188329537972524e-08,-3.0733802887519917e-08,0))
hIsland = hIsland.sub(rect(8.349504748584181e-10,8.349504748584181e-10).transl(9.075448535613194e-08,-2.705916542822701e-08,0))
hIsland = hIsland.sub(rect(4.292004381941273e-09,4.292004381941273e-09).transl(2.26402054356251e-08,4e-08,0))
hIsland = hIsland.add(rect(7.385767087557301e-09,7.385767087557301e-09).transl(-7.18690439709413e-08,-3.38902279477843e-08,0))
hIsland = hIsland.add(rect(8.887454919650605e-09,8.887454919650605e-09).transl(2.0699950867977697e-08,-4e-08,0))
hIsland = hIsland.add(rect(9.57444630855294e-09,9.57444630855294e-09).transl(4.482539487807638e-09,-4e-08,0))
hIsland = hIsland.add(rect(3.6792474007288314e-09,3.6792474007288314e-09).transl(-9.818274794959483e-09,-4e-08,0))
hIsland = hIsland.sub(rect(1.6240116132093685e-09,1.6240116132093685e-09).transl(1.0518301732065224e-07,-1.7978939917113335e-08,0))
hIsland = hIsland.add(rect(7.873390379304986e-09,7.873390379304986e-09).transl(-2.692186536510127e-08,-3.996363888938655e-08,0))
hIsland = hIsland.add(rect(2.2753282842448717e-09,2.2753282842448717e-09).transl(9.039877083208107e-08,-2.7226577454945304e-08,0))
hIsland = hIsland.add(rect(7.53900476797633e-09,7.53900476797633e-09).transl(-5.939102847327549e-08,3.6737697545140135e-08,0))
hIsland = hIsland.add(rect(1.2621684878934802e-09,1.2621684878934802e-09).transl(-2.2541144349658734e-08,4e-08,0))
hIsland = hIsland.sub(rect(1.8199041330693555e-09,1.8199041330693555e-09).transl(-6.943575994104989e-08,3.4530937879403545e-08,0))
hIsland = hIsland.add(rect(1.0420485643730259e-09,1.0420485643730259e-09).transl(-4.482526261433215e-08,3.885812960807659e-08,0))
hIsland = hIsland.add(rect(1.2322941066140447e-09,1.2322941066140447e-09).transl(-3.0836110248726845e-08,3.9854639888437244e-08,0))
hIsland = hIsland.sub(rect(2.86145121276822e-09,2.86145121276822e-09).transl(-8.191334962662122e-08,3.072291324185329e-08,0))
hIsland = hIsland.sub(rect(1.687306204335709e-09,1.687306204335709e-09).transl(-7.174272964079499e-08,-3.392459755007659e-08,0))
hIsland = hIsland.sub(rect(6.140361103098901e-09,6.140361103098901e-09).transl(-2.008615854377559e-08,4e-08,0))
hIsland = hIsland.add(rect(4.513913758730479e-09,4.513913758730479e-09).transl(8.90949279474665e-08,-2.782425435412062e-08,0))
hIsland = hIsland.add(rect(8.15283535576778e-09,8.15283535576778e-09).transl(-1.2714752481647205e-08,4e-08,0))
hIsland = hIsland.sub(rect(3.6962973219190154e-09,3.6962973219190154e-09).transl(7.146545374106117e-08,3.399961023259594e-08,0))
hIsland = hIsland.add(rect(8.756124870226773e-09,8.756124870226773e-09).transl(8.51787040492407e-08,2.9481366909457964e-08,0))
hIsland = hIsland.sub(rect(5.91736491050251e-10,5.91736491050251e-10).transl(-1.0766347827117251e-09,-4e-08,0))
hIsland = hIsland.add(rect(7.767110142521538e-10,7.767110142521538e-10).transl(-2.1581402734149696e-08,4e-08,0))
hIsland = hIsland.add(rect(9.915941917680216e-10,9.915941917680216e-10).transl(2.4216109500618172e-08,3.999650522937974e-08,0))
hIsland = hIsland.add(rect(3.9803697634950616e-09,3.9803697634950616e-09).transl(-1.8805076915331652e-08,-4e-08,0))
hIsland = hIsland.add(rect(8.55337076089751e-09,8.55337076089751e-09).transl(-8.185485432054964e-08,3.074409935519304e-08,0))
hIsland = hIsland.add(rect(3.2051371051609546e-09,3.2051371051609546e-09).transl(4.2850994573961746e-10,-4e-08,0))
hIsland = hIsland.add(rect(9.307708433938421e-09,9.307708433938421e-09).transl(3.838185113709505e-08,3.943696042976435e-08,0))
hIsland = hIsland.sub(rect(6.034520838084294e-09,6.034520838084294e-09).transl(-5.263719243949932e-08,-3.786763541307682e-08,0))
hIsland = hIsland.sub(rect(8.817153594433882e-09,8.817153594433882e-09).transl(-2.426414923536176e-08,3.999622365612298e-08,0))
hIsland = hIsland.sub(rect(9.078573236625846e-09,9.078573236625846e-09).transl(5.111894925828487e-08,-3.808587623197447e-08,0))
hIsland = hIsland.sub(rect(6.084773808295579e-09,6.084773808295579e-09).transl(-1.0299937139807584e-07,1.9753205936885647e-08,0))
hIsland = hIsland.add(rect(2.677574783544696e-09,2.677574783544696e-09).transl(7.987146159553001e-08,-3.1441838332536e-08,0))
hIsland = hIsland.add(rect(2.779590730569519e-09,2.779590730569519e-09).transl(2.4418796895072583e-08,3.99952431372159e-08,0))
hIsland = hIsland.sub(rect(7.342477511807944e-11,7.342477511807944e-11).transl(-6.963088362150276e-08,3.448119591838122e-08,0))
hIsland = hIsland.add(rect(2.4928276892964298e-09,2.4928276892964298e-09).transl(-6.265251542323486e-08,-3.609397003771127e-08,0))
hIsland = hIsland.add(rect(5.703706453568344e-09,5.703706453568344e-09).transl(4.387945728860153e-08,-3.895625063796747e-08,0))
hIsland = hIsland.add(rect(9.449457134462289e-09,9.449457134462289e-09).transl(-8.386316861912637e-08,2.9995824238809574e-08,0))
hIsland = hIsland.add(rect(8.5967830716133e-09,8.5967830716133e-09).transl(1.260499812921854e-08,-4e-08,0))
hIsland = hIsland.sub(rect(1.5451281521439265e-10,1.5451281521439265e-10).transl(-3.453137121278384e-08,-3.9684548849425216e-08,0))
hIsland = hIsland.add(rect(8.392769544672382e-09,8.392769544672382e-09).transl(4.3999360008842916e-08,3.894406555328216e-08,0))
hIsland = hIsland.add(rect(2.7277426187941212e-09,2.7277426187941212e-09).transl(-9.480794945411641e-08,2.5005172981610763e-08,0))
hIsland = hIsland.add(rect(4.834641832782549e-10,4.834641832782549e-10).transl(-3.127011556922933e-08,3.9838058739058926e-08,0))
hIsland = hIsland.add(rect(5.8497190228751505e-09,5.8497190228751505e-09).transl(-8.859599616887285e-09,-4e-08,0))
hIsland = hIsland.sub(rect(9.673661828344278e-09,9.673661828344278e-09).transl(-6.31292144199327e-08,-3.599423958859612e-08,0))


    vIsland := hIsland.rotz(pi / 2)
    vIslands := Universe().Inverse()

    hIslands := Universe().Inverse()
    hIslands = hIslands.add(hIsland.transl(-a/2, a, 0))
    hIslands = hIslands.add(hIsland.transl(-a/2, -a, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, a, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, -a, 0))
    hIslands = hIslands.add(hIsland.transl(-a/2, 0, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, 0, 0))

    vIslands = vIslands.add(vIsland.transl(-a, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(a, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(-a, -a/2, 0))
    vIslands = vIslands.add(vIsland.transl(a, -a/2, 0))
    vIslands = vIslands.add(vIsland.transl(0, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(0, -a/2, 0))

    DefRegion(1, hIslands)
    DefRegion(2, vIslands)
    TableAdd(m_full.Region(1))
    TableAdd(m_full.Region(2))
    setgeom(hIslands.add(vIslands))
    save(m)


    r2o2 := sqrt(2) / 2
    m = RandomMagSeed(4)
    B_ext = vector(Bmax*r2o2, Bmax*r2o2, 0)
    relax()
    minimize()

    for B := Bmax; B >= -Bmax; B -= Bstep {
        B_ext = vector(B*r2o2, B*r2o2, 0)
        minimize()
        tablesave()
    }

    