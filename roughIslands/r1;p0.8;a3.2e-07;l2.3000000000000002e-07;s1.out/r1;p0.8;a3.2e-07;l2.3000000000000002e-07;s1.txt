
    randSeed(1)
    ThermSeed(1)


    resolution := 2e-09
    zResolution := 5e-09
    a := 3.2e-07

    gridSize := 320 //2*a/resolution
    gridDepth := 5 //25/zResolution

    SetCellsize(resolution,resolution,zResolution)
    SetGridsize(gridSize,gridSize,gridDepth)

    SetPBC(16, 16, 0)


    Msat = 700e3
    Aex = 13e-12
    alpha = 0.2
    Bmax := 0.1
    Bstep := Bmax / 500.0


    TableAdd(B_ext)
    TableAdd(m_full)


    islandWidth := 8e-08
    islandLength := 2.3000000000000002e-07
    ellipseConstant:=9.200000000000002e-08


    hIsland := rect(islandLength-2*ellipseConstant, islandWidth)
    hIsland = hIsland.add(ellipse(ellipseConstant*2,islandWidth).transl(islandLength/2-ellipseConstant, 0, 0))
    hIsland = hIsland.add(ellipse(ellipseConstant*2,islandWidth).transl(-islandLength/2+ellipseConstant, 0, 0))
    
    hIsland = hIsland.sub(rect(1.6132573590792565e-09,1.6132573590792565e-09).transl(5.03463255876733e-08,-3.8192078664967074e-08,0))
hIsland = hIsland.add(rect(3.2040276774902177e-10,3.2040276774902177e-10).transl(-1.0886712860540717e-07,-1.4359917336451812e-08,0))
hIsland = hIsland.add(rect(2.02265498837918e-09,2.02265498837918e-09).transl(-6.813317084061507e-08,3.485589260803955e-08,0))
hIsland = hIsland.add(rect(1.2920654469914972e-09,1.2920654469914972e-09).transl(1.1371391263618532e-08,4e-08,0))
hIsland = hIsland.add(rect(4.952642612229749e-09,4.952642612229749e-09).transl(-1.9709018885185274e-08,4e-08,0))
hIsland = hIsland.sub(rect(4.7762593853159005e-09,4.7762593853159005e-09).transl(-6.326890914001665e-09,4e-08,0))
hIsland = hIsland.sub(rect(5.393217478714823e-09,5.393217478714823e-09).transl(2.1683145090974465e-08,-4e-08,0))
hIsland = hIsland.sub(rect(9.916379347533243e-09,9.916379347533243e-09).transl(6.5233764014319e-08,-3.553615581316932e-08,0))
hIsland = hIsland.add(rect(1.3732385616460041e-09,1.3732385616460041e-09).transl(-2.9606314767470717e-08,-3.989673960174387e-08,0))
hIsland = hIsland.sub(rect(7.61714515963748e-09,7.61714515963748e-09).transl(-5.417258907340041e-08,3.7633868656177494e-08,0))
hIsland = hIsland.add(rect(7.67884477420337e-09,7.67884477420337e-09).transl(6.370023336340022e-08,-3.5872835171543895e-08,0))
hIsland = hIsland.add(rect(5.371959443081787e-09,5.371959443081787e-09).transl(2.416170518211211e-09,-4e-08,0))
hIsland = hIsland.sub(rect(3.0235184247687396e-09,3.0235184247687396e-09).transl(-9.911385212809794e-09,4e-08,0))
hIsland = hIsland.add(rect(3.865000174063804e-09,3.865000174063804e-09).transl(1.0396234156775339e-08,4e-08,0))
hIsland = hIsland.add(rect(5.005079881353392e-10,5.005079881353392e-10).transl(-7.347247787245151e-08,-3.3443033350199424e-08,0))
hIsland = hIsland.sub(rect(2.4523447486136764e-09,2.4523447486136764e-09).transl(-3.56733927242492e-08,3.961865745213285e-08,0))
hIsland = hIsland.sub(rect(5.613095540773993e-09,5.613095540773993e-09).transl(9.286024226094577e-08,2.602727430593171e-08,0))
hIsland = hIsland.add(rect(4.647030290457424e-09,4.647030290457424e-09).transl(-4.194997637076229e-08,-3.9142264867650304e-08,0))
hIsland = hIsland.sub(rect(7.194951384474266e-09,7.194951384474266e-09).transl(-6.999203281965893e-08,-3.438838785928615e-08,0))
hIsland = hIsland.add(rect(8.806743925562824e-09,8.806743925562824e-09).transl(3.52522778897462e-09,4e-08,0))
hIsland = hIsland.sub(rect(5.617917828622078e-09,5.617917828622078e-09).transl(4.59641549716369e-08,-3.87338540944866e-08,0))
hIsland = hIsland.add(rect(2.901152092402143e-09,2.901152092402143e-09).transl(3.6611584040193345e-08,3.9559781709543834e-08,0))
hIsland = hIsland.add(rect(6.631056622709686e-09,6.631056622709686e-09).transl(6.22055267769002e-08,-3.6186156660593055e-08,0))
hIsland = hIsland.add(rect(5.621352644511514e-09,5.621352644511514e-09).transl(1.0159883544781105e-07,2.078889783977982e-08,0))
hIsland = hIsland.sub(rect(6.481913352845032e-09,6.481913352845032e-09).transl(-5.3708846488815585e-08,3.770587281160766e-08,0))
hIsland = hIsland.sub(rect(8.341746911821585e-09,8.341746911821585e-09).transl(-8.964317323079845e-08,2.7575939012575642e-08,0))
hIsland = hIsland.add(rect(5.82238718953033e-09,5.82238718953033e-09).transl(6.66940600230207e-08,-3.520082573009158e-08,0))
hIsland = hIsland.sub(rect(9.3302097936204e-09,9.3302097936204e-09).transl(-6.185876634492199e-08,3.6256793322524803e-08,0))
hIsland = hIsland.add(rect(1.093748185718616e-09,1.093748185718616e-09).transl(-9.651041377673779e-08,-2.405184643420686e-08,0))
hIsland = hIsland.sub(rect(9.568154116475636e-09,9.568154116475636e-09).transl(1.9540316032989938e-08,-4e-08,0))
hIsland = hIsland.add(rect(1.658436472671272e-09,1.658436472671272e-09).transl(-1.5159671936947932e-08,-4e-08,0))
hIsland = hIsland.sub(rect(1.1608001698353399e-09,1.1608001698353399e-09).transl(-5.8743774715031194e-08,3.685762360222417e-08,0))
hIsland = hIsland.add(rect(2.802623461352829e-09,2.802623461352829e-09).transl(-9.252538084007497e-08,2.619622557208465e-08,0))
hIsland = hIsland.add(rect(4.151824904239119e-09,4.151824904239119e-09).transl(5.613627044387766e-08,-3.731536165848124e-08,0))
hIsland = hIsland.add(rect(6.906031744325392e-10,6.906031744325392e-10).transl(4.127640467879365e-08,3.920276655879431e-08,0))
hIsland = hIsland.sub(rect(5.044329718172983e-09,5.044329718172983e-09).transl(8.960818936895576e-08,-2.759191242355102e-08,0))
hIsland = hIsland.add(rect(3.102314234890269e-10,3.102314234890269e-10).transl(9.099921758844776e-08,2.6942866132198486e-08,0))
hIsland = hIsland.add(rect(2.7251520432268504e-09,2.7251520432268504e-09).transl(8.657202822264318e-08,-2.891417855784176e-08,0))
hIsland = hIsland.sub(rect(7.587857608123646e-09,7.587857608123646e-09).transl(-7.868158264727585e-08,3.184188653293477e-08,0))
hIsland = hIsland.sub(rect(8.334859756610735e-09,8.334859756610735e-09).transl(3.807331228969979e-11,4e-08,0))
hIsland = hIsland.sub(rect(5.3600052595765914e-09,5.3600052595765914e-09).transl(3.061649967175153e-08,3.986268712363086e-08,0))
hIsland = hIsland.sub(rect(8.723335109299556e-09,8.723335109299556e-09).transl(-4.669191192355808e-08,-3.865091040485434e-08,0))
hIsland = hIsland.add(rect(9.130833859976298e-09,9.130833859976298e-09).transl(-1.0175853509621556e-08,4e-08,0))
hIsland = hIsland.add(rect(7.032222643476878e-09,7.032222643476878e-09).transl(-5.6194182970328656e-08,-3.7305630404961606e-08,0))
hIsland = hIsland.sub(rect(7.3618435910753356e-09,7.3618435910753356e-09).transl(-3.268784852894859e-08,3.977760859735079e-08,0))
hIsland = hIsland.sub(rect(3.5261512951027975e-10,3.5261512951027975e-10).transl(-4.969258475835531e-08,3.8279407364154084e-08,0))
hIsland = hIsland.add(rect(3.584546931120791e-10,3.584546931120791e-10).transl(4.389457567286963e-08,3.8954718289609296e-08,0))
hIsland = hIsland.add(rect(8.09382748493413e-09,8.09382748493413e-09).transl(1.1393947696767862e-08,-4e-08,0))
hIsland = hIsland.sub(rect(5.42072626247161e-09,5.42072626247161e-09).transl(1.0987953968120368e-07,-1.3158518662082364e-08,0))
hIsland = hIsland.add(rect(5.59066629836749e-09,5.59066629836749e-09).transl(-4.881037456577603e-08,-3.8393605142476e-08,0))


    vIsland := hIsland.rotz(pi / 2)
    vIslands := Universe().Inverse()

    hIslands := Universe().Inverse()
    hIslands = hIslands.add(hIsland.transl(-a/2, a, 0))
    hIslands = hIslands.add(hIsland.transl(-a/2, -a, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, a, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, -a, 0))
    hIslands = hIslands.add(hIsland.transl(-a/2, 0, 0))
    hIslands = hIslands.add(hIsland.transl(a/2, 0, 0))

    vIslands = vIslands.add(vIsland.transl(-a, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(a, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(-a, -a/2, 0))
    vIslands = vIslands.add(vIsland.transl(a, -a/2, 0))
    vIslands = vIslands.add(vIsland.transl(0, a/2, 0))
    vIslands = vIslands.add(vIsland.transl(0, -a/2, 0))

    DefRegion(1, hIslands)
    DefRegion(2, vIslands)
    TableAdd(m_full.Region(1))
    TableAdd(m_full.Region(2))
    setgeom(hIslands.add(vIslands))
    save(m)


    r2o2 := sqrt(2) / 2
    m = RandomMagSeed(4)
    B_ext = vector(Bmax*r2o2, Bmax*r2o2, 0)
    relax()
    minimize()

    for B := Bmax; B >= -Bmax; B -= Bstep {
        B_ext = vector(B*r2o2, B*r2o2, 0)
        minimize()
        tablesave()
    }

    